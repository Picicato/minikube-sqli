additionalScrapeConfigs:
  - job_name: "sqli-detector"
    metrics_path: /metrics
    static_configs:
      - targets:
          - sqli-detector.sqli-lab.svc.cluster.local:8000

alertmanager:
  config:
    global:
      resolve_timeout: 1m
    route:
      receiver: discord-sqli
      routes:
        - match:
            alertname: SQLInjectionDetected
          receiver: discord-sqli
    receivers:
      - name: discord-sqli
        slack_configs:
          - api_url: "https://discord.com/api/webhooks/1446090054580568084/mLUaar9QmGEVostzwe-QofzGn6W8jDzHPimCSoPzAcMOiuAVfYFOrG6jjM1EkK1tQic1/slack"
            send_resolved: true
            username: "SQLi Sentinel"
            icon_emoji: ":rotating_light:"
            attachments:
              - color: '{{ if eq .Status "resolved" }}#10b981{{ else if eq (or .CommonLabels.severity "") "critical" }}#e11d48{{ else if eq (or .CommonLabels.severity "") "warning" }}#f59e0b{{ else }}#3b82f6{{ end }}'
                title: "{{ .CommonLabels.alertname }} — {{ .Status | toUpper }}"
                title_link: "{{ .ExternalURL }}/#/alerts?receiver=discord-sqli"
                pretext: '{{ if eq .Status "resolved" }}:white_check_mark: RESOLVED — SQLi detector{{ else }}:rotating_light: *ALERT* SQLi detected{{ end }}'
                text: '{{ if eq .Status "resolved" }}All clear. Counter reset or no recent detections.\n*Namespace:* {{ .CommonLabels.namespace | default "-" }}\n{{ range .Alerts }}• *Pod:* {{ .Labels.pod | default "N/A" }} (resolved)\n{{ end }}{{ else }}*Namespace:* {{ .CommonLabels.namespace | default "-" }}\n{{ range .Alerts }}• *Pod:* {{ .Labels.pod | default "N/A" }}\n  *Summary:* {{ .Annotations.summary }}\n  *Details:* {{ .Annotations.description }}\n{{ end }}{{ end }}'
                footer: "Alertmanager • {{ .ExternalURL }}"
                mrkdwn_in: ["pretext", "text", "title"]

additionalPrometheusRulesMap:
  sqli-rules:
    groups:
      - name: sqli-detection
        rules:
          - alert: SQLInjectionDetected
            expr: increase(sql_injection_attempts_total[5m]) > 0
            for: 5s
            labels:
              severity: critical
            annotations:
              description: "SQL Injection detected by sqli-detector"
              summary: "SQL Injection attempt"
